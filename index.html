<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@200;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88; 
            --primary-dim: rgba(0, 255, 136, 0.1);
            --bg-dark: #09090b;
            --surface: #18181b;
            --surface-hover: #27272a;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gradient: linear-gradient(135deg, #00ff88 0%, #00b894 100%);
        }

        * { box-sizing: border-box; font-family: 'Readex Pro', sans-serif; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); overflow-x: hidden; }

        .view { display: none; opacity: 0; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(10px); }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        #vLogin { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1000; background: var(--bg-dark); }
        .auth-container { width: 90%; max-width: 400px; background: var(--surface); padding: 40px; border-radius: 30px; position: relative; border: 1px solid #333; }
        
        input, select { width: 100%; padding: 16px; border-radius: 14px; background: var(--bg-dark); border: 1px solid #333; color: #fff; margin-bottom: 15px; outline: none; transition: 0.3s; font-size: 0.95rem; font-weight: 400; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-dim); }
        
        .btn-main { background: var(--gradient); color: #000; border: none; padding: 16px; border-radius: 14px; font-weight: 800; cursor: pointer; width: 100%; font-size: 1rem; box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3); transition: 0.3s; }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5); }
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 20px 0; }

        .card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-10px);
            border-color: rgba(0, 255, 136, 0.4);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, var(--primary-dim) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: -1;
        }
        .card:hover::after { opacity: 1; }

        .img-box { 
            height: 200px; 
            width: 100%; 
            overflow: hidden; 
            position: relative;
        }
        
        .img-box img {
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            transition: transform 8s linear; 
        }

        .card:hover .img-box img {
            transform: scale(1.15);
        }

        .info-box { 
            padding: 20px; 
            text-align: right; 
            position: relative;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card h3 { 
            margin: 0; 
            font-weight: 600; 
            font-size: 1.1rem; 
            color: var(--text-main); 
            transition: color 0.3s ease;
        }
        
        .card:hover h3 { color: var(--primary); }

        .card-label { 
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem; 
            color: var(--text-muted); 
            margin-top: 8px; 
        }

        .card-label::after {
            content: 'â†';
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
            color: var(--primary);
            font-weight: bold;
        }

        .card:hover .card-label::after {
            opacity: 1;
            transform: translateX(0);
        }

        .success-overlay { display: none; position: absolute; inset: 0; background: var(--surface); border-radius: 30px; z-index: 10; flex-direction: column; align-items: center; justify-content: center; }
        .success-checkmark { width: 80px; height: 80px; margin: 0 auto; }
        .check-path { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: dash 1.5s ease-in-out forwards; stroke: var(--primary); }
        @keyframes dash { to { stroke-dashoffset: 0; } }

        #startScreen { position:fixed; inset:0; background:#000; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow: hidden; }
        .glow-bg { position: absolute; width: 300px; height: 300px; background: var(--primary); filter: blur(120px); opacity: 0.25; border-radius: 50%; z-index: -1; animation: pulse 4s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.2; } 50% { transform: scale(1.2); opacity: 0.35; } }

        .admin-card { background: var(--surface); border: 1px solid #333; border-radius: 24px; padding: 25px; margin-bottom: 25px; transition: 0.3s; }
        .code-display { font-weight: 200; font-size: 2rem; color: var(--primary); letter-spacing: 2px; }
        nav { background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(20px); padding: 15px 5%; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        
        #videoModal { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; }
        #mainPlayer { flex: 1; border: none; background: #000; }
        
        /* Admin specific styles */
        .admin-section-title { color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .admin-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .admin-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .status-badge { padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; background: #333; color: #fff; }
    </style>
</head>
<body>

    <div id="startScreen">
        <div class="glow-bg"></div>
        <h1 style="font-size: 3.5rem; margin-bottom: 20px; font-weight: 800; position: relative;">Knowledge</h1>
        <button class="btn-main" style="width: 220px;" onclick="showLogin()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù† â†</button>
    </div>

    <div id="vLogin" class="view">
        <div class="auth-container">
            <div id="successAnim" class="success-overlay">
                <svg class="success-checkmark" viewBox="0 0 52 52">
                    <circle class="check-path" cx="26" cy="26" r="25" fill="none" stroke-width="2"/>
                    <path class="check-path" fill="none" stroke-width="3" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <p style="margin-top:15px; font-weight:600;">ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­</p>
            </div>
            <h2 style="text-align: center; margin-bottom: 30px; font-weight: 800;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="tel" id="regCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…" maxlength="9" style="text-align:center; letter-spacing: 2px;">
            <button id="verifyBtn" class="btn-main" onclick="handleAuth()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            <p id="errorMsg" style="color:var(--danger); text-align:center; margin-top:15px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div id="app" style="display:none;">
        <nav>
            <div class="logo" style="font-weight:800; font-size:1.6rem;">Knowledge<span style="color:var(--primary);">.</span></div>
            <div style="display:flex; gap:12px;">
                <button id="adminBtn" onclick="nav('vAdmin')" style="display:none; background:var(--primary-dim); color:var(--primary); border:1px solid var(--primary); padding:8px 16px; border-radius:12px; cursor:pointer; font-weight:600;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                <div onclick="nav('vProfile')" style="background:var(--surface-hover); padding:10px 15px; border-radius:12px; cursor:pointer; border:1px solid #333;">ğŸ‘¤</div>
            </div>
        </nav>

        <div style="max-width: 1200px; margin: auto; padding: 25px;">
            <div id="vHome" class="view">
                <h2 style="font-weight:800; margin-bottom:10px;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
                <div class="grid" id="subjectsGrid"></div>
            </div>
            <div id="vDyn" class="view">
                <button onclick="goBack()" style="background:none; color:var(--text-muted); border:none; cursor:pointer; margin-bottom:20px; font-size:1rem;">â† Ø¹ÙˆØ¯Ø©</button>
                <h2 id="dynTitle" style="font-weight:800;"></h2>
                <div class="grid" id="dynGrid"></div>
            </div>
            <div id="vAdmin" class="view">
                <div class="admin-card">
                    <div class="admin-section-title"><h3>â• Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h3></div>
                    <div class="admin-controls">
                        <input type="text" id="admName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" style="margin:0">
                        <select id="admBranch" style="margin:0">
                            <option value="sci_med">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                            <option value="sci_math">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                            <option value="lit">Ø£Ø¯Ø¨ÙŠ</option>
                            <option value="azhar">Ø£Ø²Ù‡Ø±</option>
                        </select>
                        <select id="admTime" style="margin:0">
                            <option value="hour">Ø³Ø§Ø¹Ø©</option>
                            <option value="week">Ø£Ø³Ø¨ÙˆØ¹</option>
                            <option value="month">Ø´Ù‡Ø±</option>
                            <option value="year">Ø³Ù†Ø©</option>
                        </select>
                    </div>
                    <button class="btn-main" id="createBtn" onclick="genCode()" style="margin-top:15px;">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯</button>
                    <div id="result" style="display:none; margin-top:20px;">
                        <div style="background: #000; padding: 20px; border-radius: 15px; border: 1px dashed var(--primary); text-align: center; cursor: pointer;" onclick="copyCode()">
                            <div id="val" class="code-display">000000000</div>
                            <small style="color:var(--text-muted)">Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</small>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="admin-section-title"><h3>ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h3></div>
                    <div style="display:flex; gap:10px; margin-bottom: 20px;">
                        <input type="text" id="searchCodeInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ (9 Ø£Ø±Ù‚Ø§Ù…)" style="margin-bottom:0; font-letter-spacing:2px; text-align:center;">
                        <button class="btn-main" style="width:100px;" onclick="searchAndManageCode()">Ø¨Ø­Ø«</button>
                    </div>
                    
                    <div id="editArea" style="display:none; padding-top:20px; border-top:1px solid #333;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h4 style="margin:0;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h4>
                            <span id="deviceStatus" class="status-badge"></span>
                        </div>
                        
                        <div class="admin-controls">
                            <input type="text" id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin:0">
                            <select id="editBranch" style="margin:0">
                                <option value="sci_med">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                                <option value="sci_math">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                                <option value="lit">Ø£Ø¯Ø¨ÙŠ</option>
                                <option value="azhar">Ø£Ø²Ù‡Ø±</option>
                            </select>
                            <input type="datetime-local" id="editExpiry" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" style="margin:0">
                        </div>

                        <div class="admin-actions">
                            <button class="btn-main" onclick="updateCodeData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                            <button class="btn-main" style="background:rgba(245, 158, 11, 0.15); color:var(--warning); border:1px solid var(--warning); box-shadow:none;" onclick="resetDeviceID()">ğŸ”“ ÙÙƒ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                        </div>
                        <button class="btn-main" style="background:rgba(239,68,68,0.15); color:var(--danger); border:1px solid var(--danger); box-shadow:none; margin-top:15px;" onclick="deleteCodeData()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
                    </div>
                </div>
            </div>
            <div id="vProfile" class="view">
                <div style="background:var(--surface); padding:35px; border-radius:28px; max-width:500px; margin:auto; border:1px solid #333;">
                    <h2 style="text-align:center; margin-bottom:30px; font-weight:800;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
                    <div id="profileData"></div>
                    <button id="logoutBtn" onclick="logout()" style="margin-top:30px; width:100%; padding:15px; background:rgba(239,68,68,0.1); color:var(--danger); border:1px solid var(--danger); border-radius:14px; cursor:pointer; font-weight:600; transition:0.3s;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>
    </div>

    <div id="videoModal">
        <div style="padding:15px 25px; display:flex; justify-content:space-between; background:#111; align-items:center; border-bottom:1px solid #333;">
            <span id="vTitle" style="font-weight:600;">Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
            <button onclick="closeVideo()" style="color:#fff; background:var(--danger); border:none; padding:5px 15px; border-radius:8px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>
        </div>
        <iframe id="mainPlayer" allowfullscreen></iframe>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCeZ-J7j0bLJYICnGzlLiO7yZFIFBlA_LI",
            authDomain: "konwledge-codes.firebaseapp.com",
            projectId: "konwledge-codes",
            storageBucket: "konwledge-codes.firebasestorage.app",
            messagingSenderId: "4734976430",
            appId: "1:4734976430:web:7e65e2128deb7da662083f"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getFirestore(fApp);

        const BRANCH_RULES = {
            'sci_med': { exclude: ['Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'ØªØ§Ø±ÙŠØ®', 'Ø¬ØºØ±Ø§ÙÙŠØ§', 'Ø¥Ø­ØµØ§Ø¡', 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ø§Ø­ØµØ§Ø¡'] },
            'sci_math': { exclude: ['Ø£Ø­ÙŠØ§Ø¡', 'ØªØ§Ø±ÙŠØ®', 'Ø¬ØºØ±Ø§ÙÙŠØ§', 'Ø¥Ø­ØµØ§Ø¡', 'Ø§Ù„Ø£Ø­ÙŠØ§Ø¡', 'Ø§Ù„Ø§Ø­ØµØ§Ø¡'] },
            'lit': { exclude: ['Ø£Ø­ÙŠØ§Ø¡', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'ÙƒÙŠÙ…ÙŠØ§Ø¡', 'ÙÙŠØ²ÙŠØ§Ø¡', 'Ø§Ù„Ø£Ø­ÙŠØ§Ø¡', 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡'] },
            'azhar': { exclude: ['Ø¹Ø±Ø¨ÙŠ', 'ØªØ§Ø±ÙŠØ®', 'Ø¬ØºØ±Ø§ÙÙŠØ§', 'Ø¥Ø­ØµØ§Ø¡', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'Ø§Ù„Ø§Ø­ØµØ§Ø¡' , 'Le franÃ§ais'] }
        };

        const SOURCES = {
            "Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ": "https://platform-sigma-seven.vercel.app/organized_output-e.json",
            "Ø¹Ù„ÙˆÙ…": "https://plus-teal.vercel.app/organized_output.json",
            "Ø£Ø¯Ø¨ÙŠ": "https://plus-teal.vercel.app/organized_output-a.json"
        };

        let currentEditingId = null;

        window.nav = (id, pushState = true) => {
            if(pushState) history.pushState({viewId: id}, "");
            document.querySelectorAll('.view').forEach(v => { v.classList.remove('active'); v.style.display='none'; });
            const target = document.getElementById(id);
            if(target) {
                if(id === 'vLogin') target.style.display = 'flex';
                else target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 50);
                if(id === 'vProfile') renderProfile();
            }
        };

        window.onpopstate = (event) => {
            if (event.state && event.state.viewId) nav(event.state.viewId, false);
            else nav('vHome', false);
        };

        window.showLogin = () => {
            document.getElementById('startScreen').style.display = 'none';
            nav('vLogin');
        };

        window.handleAuth = async () => {
            const code = document.getElementById('regCode').value.trim();
            const btn = document.getElementById('verifyBtn');
            const err = document.getElementById('errorMsg');
            if(code.length < 5) return err.innerText = "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­";
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯...";
            
            if(code === "200855" || code === "2008517") {
                showSuccessAndLogin({ studentName: "Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†ØµØ©", branch: "admin", type: "admin" });
                return;
            }
            try {
                const q = query(collection(db, "codes"), where("value", "==", code));
                const snap = await getDocs(q);
                if(snap.empty) throw new Error("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
                const snapDoc = snap.docs[0];
                const data = snapDoc.data();
                const fingerprint = navigator.userAgent + screen.width;
                if(data.isUsed && data.deviceId && data.deviceId !== fingerprint) throw new Error("Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±");
                if(data.expiry && Date.now() > data.expiry) throw new Error("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯");
                if(!data.isUsed) { await updateDoc(doc(db, "codes", snapDoc.id), { isUsed: true, deviceId: fingerprint, startDate: new Date().toISOString() }); }
                showSuccessAndLogin({...data, code: code, id: snapDoc.id});
            } catch(e) { err.innerText = e.message; btn.disabled = false; btn.innerText = "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨"; }
        };

        function showSuccessAndLogin(user) {
            document.getElementById('successAnim').style.display = 'flex';
            setTimeout(() => {
                localStorage.setItem('k_user', JSON.stringify(user));
                document.getElementById('vLogin').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                if(user.type === 'admin') document.getElementById('adminBtn').style.display = 'block';
                else document.getElementById('adminBtn').style.display = 'none';
                document.getElementById('regCode').value = "";
                document.getElementById('successAnim').style.display = 'none';
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('verifyBtn').innerText = "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨";
                nav('vHome');
                loadContent();
            }, 1500);
        }

        window.logout = () => {
            const btn = document.getElementById('logoutBtn');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...";
            setTimeout(() => {
                localStorage.clear();
                document.getElementById('app').style.display = 'none';
                document.getElementById('startScreen').style.display = 'flex';
                btn.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬";
                document.getElementById('subjectsGrid').innerHTML = "";
                document.getElementById('dynGrid').innerHTML = "";
            }, 800);
        };

        window.genCode = async () => {
            const name = document.getElementById('admName').value.trim();
            const branch = document.getElementById('admBranch').value;
            const time = document.getElementById('admTime').value;
            const btn = document.getElementById('createBtn');
            if(!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨");
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯...";
            const code = Math.floor(100000000 + Math.random() * 900000000).toString();
            let expiry = Date.now();
            if(time === 'hour') expiry += 3600000;
            else if(time === 'week') expiry += 7 * 24 * 3600000;
            else if(time === 'month') expiry += 30 * 24 * 3600000;
            else if(time === 'year') expiry += 365 * 24 * 3600000;
            try {
                await addDoc(collection(db, "codes"), { value: code, studentName: name, branch: branch, expiry: expiry, isUsed: false, deviceId: null, type: 'student' });
                document.getElementById('val').innerText = code;
                document.getElementById('result').style.display = 'block';
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
            btn.disabled = false;
            btn.innerText = "Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯";
        };

        window.copyCode = () => { navigator.clipboard.writeText(document.getElementById('val').innerText); alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯"); };

        window.searchAndManageCode = async () => {
            const code = document.getElementById('searchCodeInput').value.trim();
            if(!code) return;
            const q = query(collection(db, "codes"), where("value", "==", code));
            const snap = await getDocs(q);
            if(snap.empty) return alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            const data = snap.docs[0].data();
            currentEditingId = snap.docs[0].id;
            document.getElementById('editName').value = data.studentName;
            document.getElementById('editBranch').value = data.branch;
            
            // UI Status Update
            const statusEl = document.getElementById('deviceStatus');
            if(data.deviceId) { statusEl.innerText = "Ø¬Ù‡Ø§Ø² Ù…Ø±ØªØ¨Ø· ğŸ“±"; statusEl.style.color = "var(--primary)"; }
            else { statusEl.innerText = "ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² âšª"; statusEl.style.color = "var(--text-muted)"; }

            if(data.expiry) {
                const date = new Date(data.expiry);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                document.getElementById('editExpiry').value = date.toISOString().slice(0,16);
            }
            document.getElementById('editArea').style.display = 'block';
        };

        window.updateCodeData = async () => {
            if(!currentEditingId) return;
            const name = document.getElementById('editName').value;
            const branch = document.getElementById('editBranch').value;
            const expiry = new Date(document.getElementById('editExpiry').value).getTime();
            try { await updateDoc(doc(db, "codes", currentEditingId), { studentName: name, branch: branch, expiry: expiry }); alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­"); document.getElementById('editArea').style.display = 'none'; } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); }
        };

        window.resetDeviceID = async () => {
            if(!currentEditingId) return;
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙÙƒ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ Ø³ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯.")) return;
            try { 
                await updateDoc(doc(db, "codes", currentEditingId), { deviceId: null, isUsed: false }); 
                alert("ØªÙ… ÙÙƒ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­"); 
                document.getElementById('deviceStatus').innerText = "ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² âšª";
                document.getElementById('deviceStatus').style.color = "var(--text-muted)";
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"); }
        };

        window.deleteCodeData = async () => {
            if(!currentEditingId || !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            try { await deleteDoc(doc(db, "codes", currentEditingId)); alert("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯"); document.getElementById('editArea').style.display = 'none'; } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù"); }
        };

        window.goBack = () => nav('vHome');

        async function loadContent() {
            const user = JSON.parse(localStorage.getItem('k_user'));
            if(!user) return;
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = '<p style="text-align:center; color:var(--primary);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</p>';
            try {
                const fetchPromises = Object.values(SOURCES).map(url => fetch(url, { cache: "force-cache" }).then(r => r.json()));
                const results = await Promise.all(fetchPromises);
                let allSubjectsRaw = [];
                results.forEach(d => d.forEach(m => { if(m.subjects) allSubjectsRaw.push(...m.subjects); }));
                grid.innerHTML = "";
                const rule = BRANCH_RULES[user.branch];
                const renderedNames = new Set();
                allSubjectsRaw.forEach(s => {
                    if(renderedNames.has(s.name)) return;
                    let allowed = true;
                    if(user.branch !== 'admin' && rule) { if(rule.exclude.some(word => s.name.includes(word))) allowed = false; }
                    if(allowed) {
                        renderedNames.add(s.name);
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `<div class="img-box"><img src="${s.image_url}" loading="lazy"></div><div class="info-box"><h3>${s.name}</h3><div class="card-label"><span>Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†: ${s.teachers.length}</span></div></div>`;
                        card.onclick = () => renderTeachers(s);
                        grid.appendChild(card);
                    }
                });
            } catch(e) { grid.innerHTML = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; }
        }

        function renderTeachers(subject) {
            const g = document.getElementById('dynGrid');
            document.getElementById('dynTitle').innerText = subject.name;
            g.innerHTML = "";
            nav('vDyn');
            subject.teachers.forEach(t => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="img-box"><img src="${t.image_url}" loading="lazy"></div><div class="info-box"><h3>Ø£/ ${t.name}</h3><div class="card-label"><span>Ø§Ù„ÙØµÙˆÙ„: ${t.chapters.length}</span></div></div>`;
                card.onclick = () => renderChapters(t);
                g.appendChild(card);
            });
        }

        function renderChapters(teacher) {
            const g = document.getElementById('dynGrid');
            g.innerHTML = "";
            teacher.chapters.forEach(c => {
                const card = document.createElement('div');
                card.className = 'card';
                const chapterImg = (c.image_url && c.image_url !== "") ? c.image_url : teacher.image_url;
                card.innerHTML = `<div class="img-box"><img src="${chapterImg}" loading="lazy"></div><div class="info-box"><h3>${c.name}</h3><div class="card-label"><span>Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª: ${c.lectures.length}</span></div></div>`;
                card.onclick = () => renderLectures(c, teacher.image_url);
                g.appendChild(card);
            });
        }

        function renderLectures(chapter, teacherImg) {
            const g = document.getElementById('dynGrid');
            g.innerHTML = "";
            chapter.lectures.forEach(l => {
                const card = document.createElement('div');
                card.className = 'card';
                const lectureImg = (l.image_url && l.image_url !== "") ? l.image_url : (chapter.image_url && chapter.image_url !== "") ? chapter.image_url : teacherImg;
                card.innerHTML = `<div class="img-box"><img src="${lectureImg}" loading="lazy"></div><div class="info-box"><h3>${l.name}</h3><div class="card-label"><span>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª: ${l.videos.length}</span></div></div>`;
                card.onclick = () => renderVideos(l, lectureImg);
                g.appendChild(card);
            });
        }

        function renderVideos(lecture, lectureImg) {
            const g = document.getElementById('dynGrid');
            g.innerHTML = "";
            lecture.videos.forEach(v => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="img-box"><img src="${lectureImg}" loading="lazy"></div><div class="info-box"><h3>${v.title}</h3><div class="card-label"><span style="color:var(--primary)">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¢Ù†</span></div></div>`;
                card.onclick = () => openVideo(v.name, v.stream_url);
                g.appendChild(card);
            });
        }

        window.openVideo = (title, url) => { document.getElementById('vTitle').innerText = title; document.getElementById('mainPlayer').src = "https://hlsplayer.net/embed?type=mp4&src=" + encodeURIComponent(url); document.getElementById('videoModal').style.display = 'flex'; };
        window.closeVideo = () => { document.getElementById('videoModal').style.display = 'none'; document.getElementById('mainPlayer').src = ""; };

        function renderProfile() {
            const u = JSON.parse(localStorage.getItem('k_user'));
            if(!u) return;
            const bMap = { 'sci_med':'Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…', 'sci_math':'Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©', 'lit':'Ø£Ø¯Ø¨ÙŠ', 'azhar':'Ø£Ø²Ù‡Ø±', 'admin':'Ø¥Ø¯Ø§Ø±Ø©' };
            const container = document.getElementById('profileData');
            const isExpired = u.expiry && Date.now() > u.expiry;
            const items = [{ label: 'Ø§Ù„Ø§Ø³Ù…', value: u.studentName }, { label: 'Ø§Ù„Ø´Ø¹Ø¨Ø©', value: bMap[u.branch] || u.branch }, { label: 'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨', value: u.code || 'Admin' }, { label: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨', value: isExpired ? 'ØºÙŠØ± Ù…ÙØ¹Ù„' : 'Ù…ÙØ¹Ù„', color: isExpired ? 'var(--danger)' : 'var(--primary)' }, { label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', value: u.startDate ? new Date(u.startDate).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…ØªÙˆÙØ±' }, { label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', value: u.expiry ? new Date(u.expiry).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯' }];
            container.innerHTML = items.map(i => `<div style="display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #333;"><span style="color:var(--text-muted)">${i.label}</span><span style="font-weight:600; color:${i.color || 'white'}">${i.value}</span></div>`).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('k_user'));
            if(user) { document.getElementById('startScreen').style.display = 'none'; document.getElementById('app').style.display = 'block'; if(user.type === 'admin') document.getElementById('adminBtn').style.display = 'block'; nav('vHome'); loadContent(); }
        });
    </script>
</body>
</html>

